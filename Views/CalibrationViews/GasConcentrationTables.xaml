<UserControl x:Class="CapnoAnalyzer.Views.CalibrationViews.GasConcentrationTables"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"        
             xmlns:buttons="clr-namespace:CapnoAnalyzer.Views.Components.Buttons"
             xmlns:oxy="http://oxyplot.org/wpf"
             xmlns:local="clr-namespace:CapnoAnalyzer.Views.CalibrationViews"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">
    <Grid Margin="5">
        <Border Background="#F1F3FA" CornerRadius="10" Padding="3" BorderBrush="#D1D5DB" BorderThickness="1">
            <!-- Cihaz sekmelerini yöneten ana TabControl -->
            <TabControl ItemsSource="{Binding DeviceTables}" Margin="5" Background="#F1F3FA">
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding DeviceName}" />
                    </DataTemplate>
                </TabControl.ItemTemplate>

                <TabControl.ContentTemplate>
                    <!-- Her bir cihaz sekmesinin içeriği -->
                    <DataTemplate>
                        <!-- Ana Layout Grid'i: 2 Satır (üstte ana tablo, altta sıcaklık tabloları) -->
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="3*" />
                                <RowDefinition Height="2*" />
                            </Grid.RowDefinitions>

                            <!-- ÜST BÖLÜM (Mevcut İçerik) -->
                            <Grid Grid.Row="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="5*" />
                                    <ColumnDefinition Width="2*" />
                                </Grid.ColumnDefinitions>

                                <!-- Ana Kalibrasyon DataGrid'i -->
                                <DataGrid Grid.Column="0" ItemsSource="{Binding DeviceData}" AutoGenerateColumns="False" Margin="5" VirtualizingStackPanel.IsVirtualizing="True" EnableRowVirtualization="True" HeadersVisibility="Column" CanUserAddRows="False">
                                    <DataGrid.Columns>
                                        <DataGridTemplateColumn Header="Örnek" Width="50">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Sample}" Background="LightBlue" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Gaz Konst. %" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding GasConcentration, StringFormat=F2}" Background="#FF8FE87D" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Ref" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Ref, StringFormat=F4}" Background="#DFFFD6" Foreground="#FFDE3B3B" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Gaz" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Gas, StringFormat=F4}" Background="#DFFFD6" Foreground="#FF1D58CC" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Gaz/Ref Oran" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Ratio, StringFormat=F9}" Background="#FF7DDCAA" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Geçirgenlik" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Transmittance, StringFormat=F9}" Background="#FF96C0ED" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Emilim" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Absorption, StringFormat=F9}" Background="#FF96C0ED" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Tahmin Edilen Emilim" Width="150">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding PredictedAbsorption, StringFormat=F9}" Background="#FFD87EE2" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Tahmini Gaz Konsantrasyonu %" Width="200">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding PredictedGasConcentration, StringFormat=F3}" Background="#FF8FE87D" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <!-- Sağ Panel (Katsayılar, Butonlar, Grafik) -->
                                <Grid Grid.Column="1">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Border Grid.Row="0" Grid.Column="0" Background="#F1F3FA" Margin="2" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                        <GroupBox Header="Katsayılar" Margin="3,5,3,5">
                                            <StackPanel>
                                                <TextBlock Text="Model: y = a(1 - e^(-b x^c))" FontWeight="Bold" Margin="0,0,0,5"/>
                                                <TextBlock Text="{Binding Coefficients.A, StringFormat=a: {0:F9}}"/>
                                                <TextBlock Text="{Binding Coefficients.B, StringFormat=b: {0:F9}}"/>
                                                <TextBlock Text="{Binding Coefficients.C, StringFormat=c: {0:F9}}"/>
                                                <TextBlock Text="{Binding Coefficients.R, StringFormat=R^2: {0:F9}}" FontWeight="Bold" Margin="0,5,0,0"/>
                                            </StackPanel>
                                        </GroupBox>
                                    </Border>
                                    <Border Grid.Row="0" Grid.Column="1" Background="#F1F3FA" Margin="2" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="10">
                                            <buttons:CalculateButton ButtonContent="Hesapla" Command="{Binding CalculateCommand}" />
                                            <buttons:ExportButton ButtonContent="Export" Command="{Binding ExportCommand}" Margin="0,5,0,0" />
                                        </StackPanel>
                                    </Border>
                                    <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Background="#F1F3FA" Margin="5" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                        <oxy:PlotView Model="{Binding PlotModel}" Background="#F1F3FA"/>
                                    </Border>
                                </Grid>
                            </Grid>

                            <!-- ALT BÖLÜM (DİNAMİK SICAKLIK KOMPANZASYON TABLOLARI) -->
                            <TabControl Grid.Row="1" 
                                        ItemsSource="{Binding TemperatureTests}" 
                                        SelectedItem="{Binding SelectedTest}"
                                        Margin="5">
                                <TabControl.ItemTemplate>
                                    <!-- Sekme başlığı -->
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Header}" />
                                    </DataTemplate>
                                </TabControl.ItemTemplate>

                                <TabControl.ContentTemplate>
                                    <!-- Her sekmenin içeriği -->
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>

                                            <!-- Referans Test Verileri Başlığı -->
                                            <Border Grid.Row="0" Background="#E5E7EB" CornerRadius="5" Padding="8" Margin="0,0,0,5">
                                                <WrapPanel>
                                                    <TextBlock Text="{Binding ReferenceTestData.TestNo, StringFormat=Test_No: {0}}" FontWeight="Bold" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Temperature, StringFormat=Sıcaklık: {0:F3} °C}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Pressure, StringFormat=Basınç: {0:F3}}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Humidity, StringFormat=Nem: {0:F2}}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Zero, StringFormat=ZERO: {0:F9}}" FontWeight="SemiBold" Foreground="DarkRed" Margin="15,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.SpanA, StringFormat=SPAN(a): {0:F9}}" FontWeight="SemiBold" Foreground="DarkGreen" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.B, StringFormat=b: {0:F6}}" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.C, StringFormat=c: {0:F6}}" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.R, StringFormat=R: {0:F6}}" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Alpha, StringFormat=Alfa: {0:F5}}" FontWeight="SemiBold" Foreground="DarkBlue" Margin="10,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Beta, StringFormat=Beta: {0:F5}}" FontWeight="SemiBold" Foreground="DarkOrchid" Margin="0,0,10,0"/>
                                                </WrapPanel>
                                            </Border>

                                            <!-- Sıcaklık Kompanzasyon Tablosu -->
                                            <local:TemperatureCompensationTable Grid.Row="1" DataContext="{Binding}"/>
                                        </Grid>
                                    </DataTemplate>
                                </TabControl.ContentTemplate>
                            </TabControl>
                        </Grid>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
        </Border>
    </Grid>
</UserControl>
    