<UserControl x:Class="CapnoAnalyzer.Views.CalibrationViews.GasConcentrationTables"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"        
             xmlns:buttons="clr-namespace:CapnoAnalyzer.Views.Components.Buttons"
             xmlns:oxy="http://oxyplot.org/wpf"
             xmlns:local="clr-namespace:CapnoAnalyzer.Views.CalibrationViews"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">
    <Grid Margin="5">
        <Border Background="#F1F3FA" CornerRadius="10" Padding="3" BorderBrush="#D1D5DB" BorderThickness="1">
            <TabControl ItemsSource="{Binding DeviceTables}" 
                        SelectedItem="{Binding ActiveDeviceTable, Mode=TwoWay}"
                        Margin="5" 
                        Background="#F1F3FA">

                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding DeviceName}" />
                    </DataTemplate>
                </TabControl.ItemTemplate>

                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!-- ÜST BÖLÜM (Ana Kalibrasyon İçeriği) -->
                            <Grid Grid.Row="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- Ana Kalibrasyon DataGrid'i -->
                                <DataGrid Grid.Column="0" ItemsSource="{Binding DeviceData}" AutoGenerateColumns="False" Margin="5" CanUserAddRows="False" VerticalScrollBarVisibility="Auto">
                                    <!-- Sütunlar -->
                                    <DataGrid.Columns>
                                        <DataGridTemplateColumn Header="Örnek" Width="50">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Sample}" Background="LightBlue" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Gaz Konst. %" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding GasConcentration, StringFormat=F2}" Background="#FF8FE87D" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Ref" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Ref, StringFormat=F4}" Background="#DFFFD6" Foreground="#FFDE3B3B" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Gaz" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Gas, StringFormat=F4}" Background="#DFFFD6" Foreground="#FF1D58CC" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Gaz/Ref Oran" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Ratio, StringFormat=F9}" Background="#FF7DDCAA" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Geçirgenlik" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Transmittance, StringFormat=F9}" Background="#FF96C0ED" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Emilim" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Absorption, StringFormat=F9}" Background="#FF96C0ED" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Tahmin Edilen Emilim" Width="150">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding PredictedAbsorption, StringFormat=F9}" Background="#FFD87EE2" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="Tahmini Gaz Konsantrasyonu %" Width="*">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding PredictedGasConcentration, StringFormat=F3}" Background="#FF8FE87D" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <!-- GÖRSELDEKİ GİBİ YENİDEN TASARLANMIŞ SAĞ PANEL -->
                                <Border Grid.Column="1" Background="#F1F3FA" Margin="2" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <GroupBox Grid.Column="0" Header="Katsayılar" Margin="5" Padding="5">
                                            <StackPanel>
                                                <TextBlock Text="Model: y = a(1 - e^(-b x^c))" FontWeight="Bold" Margin="0,0,0,5"/>
                                                <TextBlock Text="{Binding Coefficients.A, StringFormat=a: {0:F9}}"/>
                                                <TextBlock Text="{Binding Coefficients.B, StringFormat=b: {0:F9}}"/>
                                                <TextBlock Text="{Binding Coefficients.C, StringFormat=c: {0:F9}}"/>
                                                <TextBlock Text="{Binding Coefficients.R, StringFormat=R^2: {0:F9}}" FontWeight="Bold" Margin="0,5,0,0"/>
                                            </StackPanel>
                                        </GroupBox>

                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="5,10,10,10">
                                            <buttons:CalculateButton ButtonContent="Hesapla" Command="{Binding CalculateCommand}" />
                                            <buttons:ExportButton ButtonContent="Export" Command="{Binding ExportCommand}" Margin="0,5,0,0" />
                                            <buttons:ImportButton ButtonContent="Import" Command="{Binding ImportCommand}" Margin="0,5,0,0" />
                                        </StackPanel>

                                        <Border Grid.Column="2" Background="#F1F3FA" Margin="5" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                            <oxy:PlotView Model="{Binding PlotModel}" Background="#F1F3FA" Height="250" Width="250"/>
                                        </Border>
                                       
                                    </Grid>
                                </Border>           
                            </Grid>

                            <!-- ALT BÖLÜM (DİNAMİK SICAKLIK KOMPANZASYON TABLOLARI) -->
                            <TabControl Grid.Row="1" 
                                        ItemsSource="{Binding TemperatureTests}" 
                                        SelectedItem="{Binding SelectedTest}"
                                        Margin="5,15,5,5">
                                <TabControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Header}" />
                                    </DataTemplate>
                                </TabControl.ItemTemplate>

                                <TabControl.ContentTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>

                                            <Border Grid.Row="0" Background="#E5E7EB" CornerRadius="5" Padding="8" Margin="0,0,0,5">
                                                <WrapPanel>
                                                    <TextBlock Text="{Binding ReferenceTestData.TestNo, StringFormat=Test_No: {0}}" FontWeight="Bold" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Temperature, StringFormat=Sıcaklık: {0:F3} °C}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Pressure, StringFormat=Basınç: {0:F3}}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Humidity, StringFormat=Nem: {0:F2}}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Zero, StringFormat=ZERO: {0:F9}}" FontWeight="SemiBold" Foreground="DarkRed" Margin="15,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.SpanA, StringFormat=SPAN(a): {0:F9}}" FontWeight="SemiBold" Foreground="DarkGreen" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.B, StringFormat=b: {0:F6}}" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.C, StringFormat=c: {0:F6}}" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.R, StringFormat=R: {0:F6}}" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Alpha, StringFormat=Alfa: {0:F5}}" FontWeight="SemiBold" Foreground="DarkBlue" Margin="10,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Beta, StringFormat=Beta: {0:F5}}" FontWeight="SemiBold" Foreground="DarkOrchid" Margin="0,0,10,0"/>
                                                </WrapPanel>
                                            </Border>

                                            <Grid Grid.Row="1">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <local:TemperatureCompensationTable Grid.Column="0" DataContext="{Binding}"/>

                                                <!-- GÖRSELDEKİ GİBİ YENİDEN TASARLANMIŞ KONTROL PANELİ -->
                                                <Border Grid.Column="1" Background="#F1F3FA" Margin="10,0,0,0" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>

                                                        <StackPanel Grid.Column="0" Margin="5">
                                                            <GroupBox Header="Referans Testi Seçimi" FontWeight="Bold" Padding="5">
                                                                <ComboBox ItemsSource="{Binding DataContext.TemperatureTests, RelativeSource={RelativeSource AncestorType=TabControl}}" 
                                                                          SelectedItem="{Binding DataContext.SelectedReferenceTest, RelativeSource={RelativeSource AncestorType=TabControl}, Mode=TwoWay}" 
                                                                          DisplayMemberPath="Header"/>
                                                            </GroupBox>

                                                            <GroupBox Header="Kompanzasyon Katsayıları" FontWeight="Bold" Margin="0,10,0,0" Padding="5">
                                                                <StackPanel>
                                                                    <TextBlock Text="{Binding DataContext.CompensatedCoefficients.A, RelativeSource={RelativeSource AncestorType=TabControl}, StringFormat=a: {0:F10}}"/>
                                                                    <TextBlock Text="{Binding DataContext.CompensatedCoefficients.B, RelativeSource={RelativeSource AncestorType=TabControl}, StringFormat=b: {0:F10}}"/>
                                                                    <TextBlock Text="{Binding DataContext.CompensatedCoefficients.C, RelativeSource={RelativeSource AncestorType=TabControl}, StringFormat=c: {0:F10}}"/>
                                                                    <TextBlock Text="{Binding DataContext.CompensatedCoefficients.R, RelativeSource={RelativeSource AncestorType=TabControl}, StringFormat=R^2: {0:F10}}" FontWeight="Bold" Margin="0,5,0,0"/>
                                                                </StackPanel>
                                                            </GroupBox>
                                                        </StackPanel>

                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="5,10,10,10">
                                                            <buttons:CalculateButton ButtonContent="Hesapla" Command="{Binding DataContext.CalculateCompensationCommand, RelativeSource={RelativeSource AncestorType=TabControl}}" />
                                                            <buttons:ExportButton ButtonContent="Export" Command="{Binding DataContext.ExportCompensationCommand, RelativeSource={RelativeSource AncestorType=TabControl}}" Margin="0,5,0,0" />
                                                            <buttons:ImportButton ButtonContent="Import" Command="{Binding DataContext.ImportCompensationCommand, RelativeSource={RelativeSource AncestorType=TabControl}}" Margin="0,5,0,0" />
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </Grid>
                                        </Grid>
                                    </DataTemplate>
                                </TabControl.ContentTemplate>
                            </TabControl>
                        </Grid>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
        </Border>
    </Grid>
</UserControl>
    