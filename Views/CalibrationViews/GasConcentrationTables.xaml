<UserControl x:Class="CapnoAnalyzer.Views.CalibrationViews.GasConcentrationTables"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"        
             xmlns:buttons="clr-namespace:CapnoAnalyzer.Views.Components.Buttons"
             xmlns:faWPF="clr-namespace:FontAwesome.WPF;assembly=FontAwesome.WPF"
             xmlns:helpers="clr-namespace:CapnoAnalyzer.Helpers"
             xmlns:oxy="http://oxyplot.org/wpf"
             xmlns:local="clr-namespace:CapnoAnalyzer.Views.CalibrationViews"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">
    <Grid Margin="5">
        <Border Background="#F1F3FA" CornerRadius="10" Padding="3" BorderBrush="#D1D5DB" BorderThickness="1">

            <!-- CİHAZ SEKMELERİ (Device Tabs) -->
            <TabControl ItemsSource="{Binding DeviceTables}" 
                        SelectedItem="{Binding ActiveDeviceTable, Mode=TwoWay}"
                        Margin="5" 
                        Background="#F1F3FA">

                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding DeviceName}" />
                    </DataTemplate>
                </TabControl.ItemTemplate>

                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!-- ================================================================== -->
                            <!-- BÖLÜM 1: ANA KALİBRASYON (Main Calibration Section) -->
                            <!-- ================================================================== -->
                            <Grid Grid.Row="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- Ana Kalibrasyon DataGrid'i -->
                                <DataGrid ItemsSource="{Binding DeviceData}" 
                                          AutoGenerateColumns="False" 
                                          CanUserAddRows="False"
                                          helpers:DataGridHelper.BeginningEditCommand="{Binding ConfirmEditCommand}">
                                    <DataGrid.Columns>
                                        <!-- 1. Sütun: Silme Butonu -->
                                        <DataGridTemplateColumn Width="35">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Button Content="X" 
                                                            Background="#E63946" 
                                                            Foreground="White" 
                                                            FontWeight="Bold"
                                                            Command="{Binding DataContext.DeleteRowCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                            CommandParameter="{Binding}" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <!-- Örnek Sütunu -->
                                        <DataGridTextColumn Header="Örnek" Binding="{Binding Sample}" Width="45">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="LightBlue"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <!-- Gaz Konst. % -->
                                        <DataGridTextColumn Header="Gaz Konst. %" Binding="{Binding GasConcentration, StringFormat=F2}" Width="80">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FF8FE87D"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <!-- Ref -->
                                        <DataGridTextColumn Header="Ref" Binding="{Binding Ref, StringFormat=F4}" Width="60">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#DFFFD6"/>
                                                    <Setter Property="Foreground" Value="#FFDE3B3B"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <!-- Gaz -->
                                        <DataGridTextColumn Header="Gaz" Binding="{Binding Gas, StringFormat=F4}" Width="60">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#DFFFD6"/>
                                                    <Setter Property="Foreground" Value="#FF1D58CC"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <!-- Sıcaklık -->
                                        <DataGridTextColumn Header="Sıcaklık (°C)" Binding="{Binding Temperature, StringFormat=F2}" Width="75">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FFF4E6"/>
                                                    <Setter Property="Foreground" Value="#D35400"/>
                                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <!-- Basınç -->
                                        <DataGridTextColumn Header="Basınç" Binding="{Binding Pressure, StringFormat=F1}" Width="60">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FFF4E6"/>
                                                    <Setter Property="Foreground" Value="#555"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <!-- Nem -->
                                        <DataGridTextColumn Header="Nem (%)" Binding="{Binding Humidity, StringFormat=F1}" Width="60">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FFF4E6"/>
                                                    <Setter Property="Foreground" Value="#555"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <!-- HESAPLANAN SÜTUNLAR (IsReadOnly="True") -->
                                        <DataGridTextColumn Header="Gaz/Ref Oran" Binding="{Binding Ratio, StringFormat=F9}" Width="80" IsReadOnly="True">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FF7DDCAA"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <DataGridTextColumn Header="Geçirgenlik" Binding="{Binding Transmittance, StringFormat=F9}" Width="80" IsReadOnly="True">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FF96C0ED"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <DataGridTextColumn Header="Emilim" Binding="{Binding Absorption, StringFormat=F9}" Width="80" IsReadOnly="True">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FF96C0ED"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <DataGridTextColumn Header="Tahmin Edilen Emilim" Binding="{Binding PredictedAbsorption, StringFormat=F9}" Width="130" IsReadOnly="True">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FFD87EE2"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>

                                        <DataGridTextColumn Header="Tahmini Gaz %" Binding="{Binding PredictedGasConcentration, StringFormat=F3}" Width="*" IsReadOnly="True">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Background" Value="#FF8FE87D"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <!-- Ana Kalibrasyon Sağ Panel (Katsayılar ve Grafik) -->
                                <Border Grid.Column="1" Background="#F1F3FA" Margin="2" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0">
                                            <GroupBox Header="Katsayılar" Margin="5" Padding="5">
                                                <StackPanel>
                                                    <TextBlock Text="Model: y = a(1 - e^(-b x^c))" FontWeight="Bold" Margin="0,0,0,5"/>
                                                    <TextBlock Text="{Binding Coefficients.A, StringFormat=a: {0:F9}}"/>
                                                    <TextBlock Text="{Binding Coefficients.B, StringFormat=b: {0:F9}}"/>
                                                    <TextBlock Text="{Binding Coefficients.C, StringFormat=c: {0:F9}}"/>
                                                    <TextBlock Text="{Binding Coefficients.R, StringFormat=R^2: {0:F9}}" FontWeight="Bold" Margin="0,5,0,0"/>
                                                </StackPanel>
                                            </GroupBox>

                                            <GroupBox Header="Referans Ortam (Ortalama)" Margin="5" Padding="5" BorderBrush="#D35400">
                                                <StackPanel>
                                                    <StackPanel Orientation="Horizontal">
                                                        <faWPF:FontAwesome Icon="Thermometer" Foreground="#D35400" Width="15" VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding AverageTemperature, StringFormat=T_ref: {0:F2} °C}" FontWeight="Bold" Foreground="#D35400" Margin="5,0,0,0"/>
                                                    </StackPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                        <faWPF:FontAwesome Icon="Dashboard" Foreground="#555" Width="15" VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding AveragePressure, StringFormat=P_ref: {0:F1} hPa}" Foreground="#555" Margin="5,0,0,0"/>
                                                    </StackPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                        <faWPF:FontAwesome Icon="Tint" Foreground="#2980B9" Width="15" VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding AverageHumidity, StringFormat=H_ref: {0:F1} %}" Foreground="#2980B9" Margin="5,0,0,0"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </GroupBox>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="5,10,10,10">
                                            <buttons:CalculateButton ButtonContent="Hesapla" Command="{Binding CalculateCommand}" />
                                            <buttons:ExportButton ButtonContent="Export" Command="{Binding ExportCommand}" Margin="0,5,0,0" />
                                            <buttons:ImportButton ButtonContent="Import" Command="{Binding ImportCommand}" Margin="0,5,0,0" />
                                        </StackPanel>

                                        <Border Grid.Column="2" Background="#F1F3FA" Margin="5" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                            <oxy:PlotView Model="{Binding PlotModel}" Background="#F1F3FA" Height="250" Width="250"/>
                                        </Border>
                                    </Grid>
                                </Border>
                            </Grid>

                            <!-- ================================================================== -->
                            <!-- BÖLÜM 2: SICAKLIK KOMPANZASYON TABLOLARI (Temperature Compensation) -->
                            <!-- ================================================================== -->
                            <TabControl Grid.Row="1" 
                                        ItemsSource="{Binding TemperatureTests}" 
                                        SelectedItem="{Binding SelectedTest}"
                                        Margin="5,15,5,5">
                                <TabControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Header}" />
                                    </DataTemplate>
                                </TabControl.ItemTemplate>

                                <TabControl.ContentTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>

                                            <!-- Sıcaklık Testi Başlık Bilgileri -->
                                            <Border Grid.Row="0" Background="#E5E7EB" CornerRadius="5" Padding="8" Margin="0,0,0,5">
                                                <WrapPanel>
                                                    <TextBlock Text="{Binding ReferenceTestData.TestNo, StringFormat=Test_No: {0}}" FontWeight="Bold" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Temperature, StringFormat=Test Ort. Sıcaklık: {0:F2} °C}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Pressure, StringFormat=Test Ort. Basınç: {0:F2}}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Humidity, StringFormat=Test Ort. Nem: {0:F2}}" Margin="0,0,15,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Zero, StringFormat=ZERO(ref): {0:F9}}" FontWeight="SemiBold" Foreground="DarkRed" Margin="15,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.SpanA, StringFormat=SPAN(a): {0:F9}}" FontWeight="SemiBold" Foreground="DarkGreen" Margin="0,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Alpha, StringFormat=Alfa: {0:F5}}" FontWeight="SemiBold" Foreground="DarkBlue" Margin="10,0,10,0"/>
                                                    <TextBlock Text="{Binding ReferenceTestData.Beta, StringFormat=Beta: {0:F5}}" FontWeight="SemiBold" Foreground="DarkOrchid" Margin="0,0,10,0"/>
                                                </WrapPanel>
                                            </Border>

                                            <Grid Grid.Row="1">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <local:TemperatureCompensationTable Grid.Column="0" DataContext="{Binding}"/>

                                                <Border Grid.Column="1" Background="#F1F3FA" Margin="10,0,0,0" CornerRadius="10" BorderBrush="#E5E7EB" BorderThickness="1">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>

                                                        <StackPanel Grid.Column="0" Margin="5">
                                                            <GroupBox Header="Referans Ortam (Ana Kalibrasyon)" FontWeight="Bold" Padding="5" BorderBrush="#D35400">
                                                                <StackPanel>
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <faWPF:FontAwesome Icon="Thermometer" Foreground="#D35400" Width="15" VerticalAlignment="Center"/>
                                                                        <TextBlock Text="{Binding DataContext.AverageTemperature, RelativeSource={RelativeSource AncestorType=TabControl}, StringFormat=T_ref: {0:F2} °C}" 
                                                                                   FontWeight="Bold" Foreground="#D35400" Margin="5,0,0,0"/>
                                                                    </StackPanel>
                                                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                                        <faWPF:FontAwesome Icon="Dashboard" Foreground="#555" Width="15" VerticalAlignment="Center"/>
                                                                        <TextBlock Text="{Binding DataContext.AveragePressure, RelativeSource={RelativeSource AncestorType=TabControl}, StringFormat=P_ref: {0:F1} hPa}" 
                                                                                   Foreground="#555" Margin="5,0,0,0"/>
                                                                    </StackPanel>
                                                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                                        <faWPF:FontAwesome Icon="Tint" Foreground="#2980B9" Width="15" VerticalAlignment="Center"/>
                                                                        <TextBlock Text="{Binding DataContext.AverageHumidity, RelativeSource={RelativeSource AncestorType=TabControl}, StringFormat=H_ref: {0:F1} %}" 
                                                                                   Foreground="#2980B9" Margin="5,0,0,0"/>
                                                                    </StackPanel>
                                                                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                                                        <TextBlock Text="Zero_ref: " Foreground="Gray" FontSize="11"/>
                                                                        <TextBlock Text="{Binding ReferenceTestData.Zero, StringFormat={}{0:F6}}" Foreground="#2980B9" FontSize="11" FontWeight="SemiBold"/>
                                                                    </StackPanel>
                                                                </StackPanel>
                                                            </GroupBox>

                                                            <GroupBox Header="Termal Model Parametreleri" FontWeight="Bold" Margin="0,10,0,0" Padding="5" BorderBrush="#8E44AD">
                                                                <StackPanel>
                                                                    <StackPanel Orientation="Horizontal" Margin="0,2">
                                                                        <TextBlock Text="Alfa (α): " Foreground="Gray" Width="60"/>
                                                                        <TextBlock Text="{Binding ReferenceTestData.Alpha, StringFormat={}{0:F6}}" Foreground="DarkBlue" FontWeight="Bold"/>
                                                                    </StackPanel>
                                                                    <StackPanel Orientation="Horizontal" Margin="0,2">
                                                                        <TextBlock Text="Beta (β): " Foreground="Gray" Width="60"/>
                                                                        <TextBlock Text="{Binding ReferenceTestData.Beta, StringFormat={}{0:F6}}" Foreground="DarkOrchid" FontWeight="Bold"/>
                                                                    </StackPanel>
                                                                    <Separator Margin="0,5"/>
                                                                    <TextBlock Text="Baz Model (Ana Kalib.)" FontSize="10" Foreground="Gray" Margin="0,0,0,2"/>
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="Span (A): " Foreground="Gray" Width="60"/>
                                                                        <TextBlock Text="{Binding ReferenceTestData.SpanA, StringFormat={}{0:F6}}" Foreground="#2E3B4E"/>
                                                                    </StackPanel>
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="Exp (B): " Foreground="Gray" Width="60"/>
                                                                        <TextBlock Text="{Binding ReferenceTestData.B, StringFormat={}{0:F6}}" Foreground="#2E3B4E"/>
                                                                    </StackPanel>
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="Pow (C): " Foreground="Gray" Width="60"/>
                                                                        <TextBlock Text="{Binding ReferenceTestData.C, StringFormat={}{0:F6}}" Foreground="#2E3B4E"/>
                                                                    </StackPanel>
                                                                </StackPanel>
                                                            </GroupBox>
                                                        </StackPanel>

                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="5,10,10,10">
                                                            <buttons:CalculateButton ButtonContent="Hesapla" Command="{Binding DataContext.CalculateCompensationCommand, RelativeSource={RelativeSource AncestorType=TabControl}}" />
                                                            <buttons:ExportButton ButtonContent="Export" Command="{Binding DataContext.ExportCompensationCommand, RelativeSource={RelativeSource AncestorType=TabControl}}" Margin="0,5,0,0" />
                                                            <buttons:ImportButton ButtonContent="Import" Command="{Binding DataContext.ImportCompensationCommand, RelativeSource={RelativeSource AncestorType=TabControl}}" Margin="0,5,0,0" />
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </Grid>
                                        </Grid>
                                    </DataTemplate>
                                </TabControl.ContentTemplate>
                            </TabControl>
                        </Grid>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
        </Border>
    </Grid>
</UserControl>
    